# 用户积分系统 - 需求规格文档

生成时间：2026-02-21
最后更新：2026-02-21（集成 analyst 修复决策）

## 目标

构建一个完整的用户积分系统，支持用户通过日常行为（登录、购买、分享等）自动获得积分，并能够兑换积分为实际权益。系统需要提供积分查询、明细追踪、过期管理和兑换功能，同时支持管理员灵活配置积分规则。

## 用户故事

### US-001：用户自动获得积分
作为普通用户，我希望完成登录、购买、分享等行为后自动获得积分，以便通过日常使用积累奖励。

**验收条件：**
- 用户完成已配置的行为后，积分余额在5秒内正确增加对应数值（P99 延迟 <= 5秒）
- 同一行为在配置了频率限制时，重复触发不重复发放
- 积分发放同时生成一条明细记录，包含行为类型、数值、时间戳
- 积分发放为同步写入，不依赖异步队列

### US-002：用户兑换积分
作为普通用户，我希望用积分兑换优惠券、商品或其他权益，以便将积累的积分转化为实际价值。

**验收条件：**
- 余额不足时兑换请求返回明确错误，余额不变
- 兑换成功后余额扣减正确，同时生成扣减明细记录
- 兑换操作具有原子性（扣减与权益发放要么同时成功，要么同时回滚）
- 兑换时优先扣减最早到期的积分批次（FIFO）
- 兑换操作在单库事务内完成，不涉及外部系统调用

### US-003：用户查看积分余额和明细
作为普通用户，我希望随时查看积分余额和收支明细，以便了解积分来源与消耗情况。

**验收条件：**
- 余额查询返回当前可用积分总额（已扣除过期部分）
- 余额查询接口（GET /api/points/balance）在响应中附带 expiring_soon 字段，返回7天内即将过期的积分数量（expires_at 在 NOW() 和 NOW() + 7天之间的积分总数）
- 明细列表支持分页，按时间倒序，包含类型、数值、时间、备注

### US-004：用户接收过期提醒
作为普通用户，我希望在积分即将过期时收到提醒，以便及时使用避免浪费。

**验收条件：**
- 超过有效期的积分批次自动标记为过期，不再计入可用余额
- 过期处理生成对应的过期明细记录
- 过期提醒通过被动查询模式实现：余额查询接口返回 expiring_soon 字段，用户主动查询时获知即将过期的积分

### US-005：管理员配置积分规则
作为系统管理员，我希望配置不同行为的积分规则和有效期策略，以便灵活调整运营策略。

**验收条件：**
- 支持配置行为类型、积分数值、频率限制、有效期
- 配置变更对新发放的积分立即生效
- V1 版本通过 SQL seed 脚本配置 action_type 规则，管理员 UI 和 API 均排除在 V1 范围外

## 验收标准

### 功能验收标准

| 功能项 | 验收标准 |
|--------|--------|
| 积分发放 | 用户完成已配置的行为后，积分余额在5秒内正确增加对应数值（P99 <= 5秒） |
| 频率限制 | 同一行为在配置了频率限制时，重复触发不重复发放；粒度为 user_id + action_type 组合，采用滑动窗口算法；通过 points_transactions 表 COUNT 查询实现，不引入 Redis |
| 明细记录 | 积分发放同时生成一条明细记录，包含行为类型、数值、时间戳 |
| 兑换验证 | 余额不足时兑换请求返回明确错误，余额不变 |
| 兑换扣减 | 兑换成功后余额扣减正确，同时生成扣减明细记录 |
| 兑换原子性 | 兑换操作在单库事务内完成（扣减积分 + 创建兑换记录），使用行级锁（SELECT FOR UPDATE）保证并发安全；积分扣减与兑换记录在同一 DB 事务中提交，不涉及外部系统调用 |
| 余额查询 | 余额查询返回当前可用积分总额（已扣除过期部分），附带 expiring_soon 字段（7天内即将过期的积分数量） |
| 明细查询 | 明细列表支持分页，按时间倒序，包含类型、数值、时间、备注 |
| 过期处理 | 超过有效期的积分批次自动标记为过期，不再计入可用余额；无定时任务，采用惰性过期机制：查询时检测过期批次，写入过期流水记录，更新批次状态为 expired |
| 过期记录 | 过期处理生成对应的过期明细记录 |
| 兑换优先级 | 兑换时优先扣减最早到期的积分批次（FIFO） |
| 幂等性 | 通过 Idempotency-Key 请求头实现，24小时窗口，存储在数据库中 |

## 技术约束

### 并发安全
- 使用数据库事务 + 行级锁确保并发操作的数据一致性
- 积分发放和兑换操作必须在事务内完成
- 兑换操作使用 SELECT FOR UPDATE 进行行级锁定

### 批次模型
- 积分按批次存储，每个批次包含：
  - 用户ID
  - 积分数值
  - 行为类型
  - 发放时间（issued_at）
  - 到期时间（expires_at = issued_at + validity_days）
  - 状态（可用/已兑换/已过期）

### 有效期计算
- 积分有效期从 issued_at（发放时间）起算
- expires_at = issued_at + validity_days
- validity_days 默认365天，管理员可通过 action_type 配置调整
- 过期积分通过惰性过期机制处理：查询时检测过期批次，写入过期流水记录，更新批次状态为 expired

### 过期处理
- 无定时任务执行过期积分的标记
- 采用惰性过期机制：查询时检测过期批次（expiresAt < NOW() 且 status = active），在事务内写入过期流水记录并更新批次状态为 expired
- 过期积分自动失效，不再计入可用余额
- 过期处理不影响已兑换的积分记录

### 幂等性
- 行为触发接口支持幂等，相同请求多次调用结果一致
- 使用 Idempotency-Key 请求头作为幂等键
- 24小时窗口内的重复请求返回相同结果
- 幂等键存储在数据库中

### 频率限制
- 频率限制粒度 = user_id + action_type 组合
- 采用滑动窗口算法
- 窗口大小和上限由 action_type 配置决定

### 积分发放
- 积分发放为同步写入，不依赖异步队列
- P99 延迟 <= 5秒

### 过期提醒
- 采用被动查询模式，不主动推送通知
- 余额查询接口（GET /api/points/balance）在响应中附带 expiring_soon 字段
- expiring_soon 字段返回7天内即将过期的积分数量

### 审计追溯
- 所有积分变动记录不可物理删除
- 记录包含操作人、操作时间、操作类型、变动前后值

## 排除范围

以下功能不在本期范围内：
- 积分转赠（用户间转账）
- 积分商城前端（兑换商品的UI界面）
- 多积分类型（仅支持单一积分体系）
- 管理后台（管理员配置界面）
- 第三方集成（与外部系统的对接）
- 定时任务（过期积分标记）
- 主动通知（过期提醒推送）

## 技术栈

- **前端框架**：Next.js
- **编程语言**：TypeScript
- **ORM**：Prisma
- **数据库**：PostgreSQL
- **运行时**：Node.js 20+
