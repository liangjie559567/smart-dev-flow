# AI API 中转站 - 需求规格文档

**文档版本**: 1.0  
**生成日期**: 2026-02-21  
**状态**: 待审核

---

## 1. 项目目标

构建一个 OpenAI 兼容的 API 中转平台，支持用户通过 OAuth 登录、获取 API Key、调用 AI 模型，并提供完整的计费、用量统计和管理后台功能。

**核心价值**:
- 用户可通过 GitHub/Google 快速登录并获得 API Key
- 支持流式调用，兼容 OpenAI 接口规范
- 原子性扣费，防止超额消费
- 实时用量统计和成本管理

---

## 2. 用户故事

### US-1: 用户通过 OAuth 登录并获取 API Key
**角色**: 开发者  
**场景**: 首次访问平台，希望快速获得 API Key 用于开发  
**验收条件**:
- 支持 GitHub 和 Google OAuth 登录
- 登录成功后自动生成格式为 `sk-` 开头的 API Key
- API Key 显示一次，用户可复制保存
- 用户可在账户页面查看和吊销 API Key

### US-2: 用户调用 AI API 并获得流式响应
**角色**: 开发者  
**场景**: 使用 API Key 调用 `/v1/chat/completions` 端点  
**验收条件**:
- 接口返回 OpenAI 兼容格式
- 支持流式 SSE 响应
- 余额不足时返回 HTTP 402 状态码
- 调用记录实时写入数据库

### US-3: 用户查看用量统计和成本
**角色**: 开发者  
**场景**: 登录后台查看本月 API 调用情况  
**验收条件**:
- 显示 30 天用量折线图（按天统计）
- 显示调用历史列表（支持按模型、日期筛选）
- 显示当前余额和套餐额度
- 支持导出用量报告

### US-4: 用户购买套餐并自动扣费
**角色**: 开发者  
**场景**: 余额不足，购买套餐获得额度  
**验收条件**:
- 套餐额度优先于余额消费
- 扣费原子性保证（不会出现超额或重复扣费）
- 扣费失败时返回 402，不消耗额度
- 扣费记录可追溯

### US-5: 管理员配置模型和调整用户余额
**角色**: 平台管理员  
**场景**: 需要上线新模型或手动调整用户余额  
**验收条件**:
- 管理后台支持添加/编辑模型配置
- 模型配置变更实时生效（无需重启）
- 支持手动增减用户余额
- 支持查看平台收益统计

---

## 3. 验收标准（按模块）

### 3.1 账户与认证模块
- [ ] GitHub OAuth 集成，自动创建用户账户
- [ ] Google OAuth 集成，自动创建用户账户
- [ ] 首次登录自动生成 API Key（格式: `sk-` + 32位随机字符）
- [ ] API Key 吊销后立即失效（缓存失效时间 ≤ 5 秒）
- [ ] 支持多个 API Key 管理（创建、查看、吊销）
- [ ] 用户信息页面显示账户余额、套餐额度、过期时间

### 3.2 API 代理模块
- [ ] `POST /v1/chat/completions` 端点实现
- [ ] 验证 API Key 有效性和余额充足
- [ ] 支持流式响应（SSE 格式）
- [ ] 余额不足返回 HTTP 402 Insufficient Funds
- [ ] 代理请求到上游 OpenAI API
- [ ] 记录调用日志（模型、tokens、耗时、状态码）
- [ ] 支持 Vercel Edge Runtime 和 Docker 自托管

### 3.3 计费与套餐模块
- [ ] 支持定义多个套餐（按 tokens 或调用次数）
- [ ] 套餐额度优先于余额消费
- [ ] 原子性扣费（MySQL 事务 + SELECT FOR UPDATE）
- [ ] 扣费失败时自动回滚，不消耗额度
- [ ] 支持套餐过期自动清零
- [ ] 支持手动充值余额（管理员操作）

### 3.4 用量统计模块
- [ ] 30 天用量折线图（按天聚合）
- [ ] 调用历史列表（分页，每页 20 条）
- [ ] 支持按模型、日期范围、状态码筛选
- [ ] 显示总 tokens、总调用次数、总成本
- [ ] 实时更新（延迟 ≤ 1 分钟）
- [ ] 支持导出 CSV 格式报告

### 3.5 管理后台模块
- [ ] 模型管理：添加、编辑、启用/禁用模型
- [ ] 模型配置变更实时生效（无需重启）
- [ ] 用户管理：查看用户列表、手动调整余额
- [ ] 收益统计：按天/月统计平台总收益
- [ ] 操作日志：记录所有管理员操作
- [ ] 支持基于角色的访问控制（RBAC）

---

## 4. 技术约束

### 4.1 技术栈
- **框架**: Next.js 15（App Router）
- **数据库**: MySQL 8.0+
- **ORM**: Drizzle ORM
- **认证**: NextAuth.js v5
- **运行时**: Vercel Edge Runtime 或 Docker

### 4.2 流式处理
- 使用 `ReadableStream` + `TransformStream` 实现流式代理
- **禁止缓冲整个响应**，必须逐块转发
- SSE 格式: `data: {json}\n\n`

### 4.3 数据库事务
- 扣费操作必须在 MySQL 事务内执行
- 使用 `SELECT ... FOR UPDATE` 防止并发扣费
- 事务隔离级别: `REPEATABLE READ`

### 4.4 缓存策略
- API Key 验证结果缓存 5 秒（Redis 或内存）
- 模型配置缓存 1 分钟
- 用户余额缓存 10 秒

### 4.5 性能要求
- API 响应时间 ≤ 200ms（不含上游 API 延迟）
- 并发支持 ≥ 1000 req/s
- 数据库连接池大小 ≥ 20

---

## 5. 排除范围

- ❌ 支付网关集成（Stripe、支付宝等）
- ❌ 多租户架构
- ❌ 文件上传功能
- ❌ 移动端应用
- ❌ 实时通知系统（邮件、短信）
- ❌ 高级分析（机器学习、异常检测）

---

## 6. 关键风险

| 风险 | 影响 | 缓解措施 |
|------|------|--------|
| **并发扣费导致超额** | 高 | 使用 SELECT FOR UPDATE + 事务隔离 |
| **流式响应中断** | 中 | 实现重试机制和错误恢复 |
| **API Key 泄露** | 高 | 支持快速吊销，记录异常调用 |
| **上游 API 限流** | 中 | 实现本地限流和队列机制 |
| **数据库连接耗尽** | 高 | 配置连接池和超时控制 |
| **缓存不一致** | 中 | 实现缓存失效策略和定期同步 |

---

## 7. 交付物清单

- [ ] 数据库 Schema（用户、API Key、调用记录、套餐等）
- [ ] API 端点实现（认证、代理、统计、管理）
- [ ] 前端页面（登录、仪表板、管理后台）
- [ ] 单元测试（覆盖率 ≥ 80%）
- [ ] 集成测试（流式响应、扣费、并发）
- [ ] 部署文档（Vercel 和 Docker）
- [ ] API 文档（OpenAPI 规范）

---

## 8. 时间估算

| 模块 | 工作量 | 优先级 |
|------|--------|--------|
| 账户与认证 | 3 天 | P0 |
| API 代理 | 4 天 | P0 |
| 计费与套餐 | 3 天 | P0 |
| 用量统计 | 2 天 | P1 |
| 管理后台 | 2 天 | P1 |
| 测试与优化 | 3 天 | P0 |
| **总计** | **17 天** | - |

---

**审核状态**: 待 Analyst 和 Architect 确认  
**下一步**: 生成详细设计文档和任务分解
