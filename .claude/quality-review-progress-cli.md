# 需求审查报告：任务进度看板 CLI

**审查时间**：2026-02-21  
**审查员**：Quality Reviewer  
**需求**：node scripts/progress.mjs 任务进度看板  
**审查结论**：**退回** - Critical 问题未解决

---

## 审查结果

### 综合评分：45/100

**建议**：**退回修改** - 需求文档存在多个 Critical 问题，无法进入架构设计阶段。

---

## Critical 问题（必须解决）

### 1. ❌ 数据源定义不完整

**问题**：需求文档声称"数据源结构已定义"，但实际情况：

- **manifest.md 不存在**：搜索结果为 0 匹配
- **数据源格式未定义**：
  - 任务表格的列名是什么？
  - 状态字段的可能值有哪些？
  - fail_count、rollback_count 在哪个文件中？
  - 完成记录的存储位置和格式是什么？

**证据**：
```
搜索 manifest.md：0 结果
active_context.md 中存在的字段：
  - task_status: DRAFTING
  - fail_count: 0
  - rollback_count: 0
  - 但无"完成记录"字段
```

**影响**：无法确定数据读取逻辑，架构设计无法进行。

---

### 2. ❌ 输出格式未定义

**问题**：需求文档声称"输出示例已提供"，但实际情况：

- 没有看到具体的输出示例（表格/列表/其他格式）
- 没有定义每个状态对应的 ANSI 颜色方案
- 没有定义"最近5条完成记录"的显示格式
- 没有定义 fail_count、rollback_count 的显示位置

**需要补充**：
```
示例输出：
┌─────────────────────────────────────┐
│ 任务进度看板                         │
├─────────────────────────────────────┤
│ 当前阶段：Phase 1 - Drafting        │
│ 失败次数：0  回滚次数：0            │
├─────────────────────────────────────┤
│ 任务列表：                          │
│ [✓] 任务1 - COMPLETED              │
│ [→] 任务2 - IMPLEMENTING           │
│ [ ] 任务3 - IDLE                   │
├─────────────────────────────────────┤
│ 最近完成（5条）：                   │
│ 2026-02-20 17:13 - 任务1           │
└─────────────────────────────────────┘
```

---

### 3. ❌ 命令行接口未定义

**问题**：需求文档声称"命令行接口已定义"，但实际情况：

- 没有定义命令行参数（如 `--format json`、`--watch` 等）
- 没有定义退出码规范
- 没有定义错误消息格式
- 没有定义 PostToolUse 钩子的调用方式和参数

**需要补充**：
```
用法：node scripts/progress.mjs [选项]

选项：
  --format <type>    输出格式 (ansi|json|text)，默认 ansi
  --watch            监视模式，每秒刷新
  --compact          紧凑模式，仅显示摘要
  --help             显示帮助信息

退出码：
  0 - 成功
  1 - 数据源不存在
  2 - 解析错误
  3 - 权限错误

PostToolUse 集成：
  触发条件：Write/Edit 操作后
  调用方式：node scripts/progress.mjs --format json
  输出处理：解析 JSON，更新 HUD 显示
```

---

### 4. ❌ 数据源路径不明确

**问题**：

- manifest.md 应该在哪个目录？（`.agent/memory/`？`.omc/`？项目根目录？）
- active_context.md 的路径是 `.agent/memory/active_context.md`，但需求文档没有明确说明
- 完成记录应该存储在哪里？（新建文件？追加到现有文件？）

**影响**：无法编写可靠的文件读取逻辑。

---

### 5. ❌ 状态映射未定义

**问题**：

- active_context.md 中的 task_status 值有哪些？（IDLE、DRAFTING、CONFIRMING、REVIEWING、DECOMPOSING、IMPLEMENTING、REFLECTING、BLOCKED）
- 每个状态对应的显示文本是什么？（中文/英文？）
- 每个状态对应的 ANSI 颜色是什么？

**需要补充**：
```javascript
const statusMap = {
  IDLE: { text: '待开始', color: '\x1b[90m' },      // 灰色
  DRAFTING: { text: '起草中', color: '\x1b[33m' },  // 黄色
  CONFIRMING: { text: '待确认', color: '\x1b[36m' }, // 青色
  REVIEWING: { text: '评审中', color: '\x1b[35m' },  // 紫色
  DECOMPOSING: { text: '拆解中', color: '\x1b[34m' }, // 蓝色
  IMPLEMENTING: { text: '实现中', color: '\x1b[32m' }, // 绿色
  REFLECTING: { text: '复盘中', color: '\x1b[33m' },  // 黄色
  BLOCKED: { text: '已阻塞', color: '\x1b[31m' }     // 红色
};
```

---

## High 问题（应该解决）

### 6. ⚠️ 性能约束未验证

**问题**：

- 要求执行时间 <500ms，但没有定义测试数据规模
- 没有定义性能测试方法
- 没有定义在大数据量下的降级策略

**建议**：
```
性能测试标准：
- 小规模：10 个任务，<100ms
- 中规模：100 个任务，<300ms
- 大规模：1000 个任务，<500ms
```

---

### 7. ⚠️ 降级处理不完整

**问题**：

- 需求说"数据源不存在时友好提示"，但没有定义具体的提示文本
- 没有定义部分数据源缺失时的处理方式（如 manifest.md 存在但 active_context.md 不存在）
- 没有定义错误恢复策略

**需要补充**：
```
降级场景：
1. manifest.md 不存在 → 显示"未找到任务清单，请运行 /dev-flow 创建任务"
2. active_context.md 不存在 → 显示"未找到活跃上下文，系统处于 IDLE 状态"
3. 两者都不存在 → 显示"系统初始化中，请稍候..."
4. 文件解析失败 → 显示"数据源格式错误，请检查文件内容"
```

---

### 8. ⚠️ PostToolUse 集成方式不明确

**问题**：

- 需求说"PostToolUse 钩子集成"，但没有定义集成点
- 没有定义钩子应该如何调用这个脚本
- 没有定义输出应该如何处理（打印到控制台？写入文件？返回给钩子？）

**需要补充**：
```javascript
// 在 hooks/post-tool-use.cjs 中的集成方式
// 触发条件：Write/Edit 操作成功后
// 调用方式：
const { execSync } = require('child_process');
const output = execSync('node scripts/progress.mjs --format json', {
  encoding: 'utf-8',
  stdio: ['pipe', 'pipe', 'pipe']
});
// 输出处理：解析 JSON，更新 HUD 显示
```

---

## 验收标准完整性检查

| # | 验收标准 | 状态 | 问题 |
|---|---------|------|------|
| 1 | 显示所有任务名称、状态 | ❌ | 任务数据源不存在 |
| 2 | 当前阶段状态与 active_context.md 一致 | ⚠️ | 状态映射未定义 |
| 3 | ANSI 彩色输出 | ❌ | 颜色方案未定义 |
| 4 | 显示 fail_count、rollback_count | ⚠️ | 显示位置未定义 |
| 5 | 显示最近5条完成记录（时间倒序） | ❌ | 完成记录存储位置未定义 |
| 6 | 无外部依赖 | ✅ | 清晰 |
| 7 | PostToolUse 钩子集成 | ❌ | 集成方式未定义 |
| 8 | 执行时间 <500ms | ⚠️ | 性能测试标准未定义 |

---

## 建议修改清单

**必须完成**（进入架构设计前）：

- [ ] 定义 manifest.md 的完整结构（列名、数据格式、存储位置）
- [ ] 定义完成记录的存储格式和位置
- [ ] 提供具体的输出示例（包括 ANSI 颜色）
- [ ] 定义状态映射表（状态值 → 显示文本 + 颜色）
- [ ] 定义命令行参数和退出码规范
- [ ] 定义 PostToolUse 钩子的集成方式
- [ ] 定义降级处理的具体提示文本
- [ ] 定义性能测试标准和测试数据规模

**应该完成**（提高质量）：

- [ ] 补充错误恢复策略
- [ ] 补充部分数据源缺失时的处理方式
- [ ] 补充监视模式（--watch）的实现细节

---

## 结论

**当前状态**：需求文档不完整，存在 5 个 Critical 问题和 3 个 High 问题。

**建议**：
1. 补充上述所有 Critical 问题的定义
2. 重新提交需求文档进行审查
3. 审查通过后进入架构设计阶段

**预计修改工作量**：1-2 小时（需求澄清和文档补充）

---

**审查员签名**：Quality Reviewer  
**审查时间**：2026-02-21 14:30 UTC
