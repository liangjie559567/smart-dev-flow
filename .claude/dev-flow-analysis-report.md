# dev-flow 流程测试分析报告

**测试需求**：axiom-status 任务进度从 manifest.md 读取
**测试日期**：2026-02-21
**测试结果**：实现完成（5/5 测试通过，AC-1/2/3/4/5 全部通过）

---

## 一、不一致问题汇总（7条）

### #1 初始化状态污染
**阶段**：会话初始化
**定义行为**：active_context.md 应有唯一 last_updated 字段，状态与正文一致
**实际行为**：字段重复3次，task_status=DRAFTING 但正文说"无活跃任务"
**根因**：多次写入未做幂等处理，YAML frontmatter 追加而非替换
**影响**：状态混乱，需手动重置才能继续
**建议**：写入 active_context.md 时先解析再整体替换 frontmatter，禁止追加写入

---

### #2 AskUserQuestion 工具约束与开放文本收集冲突
**阶段**：IDLE 引导
**定义行为**：收集"需求描述"开放文本（dev-flow SKILL.md 第一步）
**实际行为**：AskUserQuestion 要求每个问题至少2个选项，无法收集开放文本
**根因**：dev-flow 设计时未考虑 Claude Code 工具约束
**影响**：需求描述只能通过预设选项间接获取，无法捕获用户自由表达的需求
**建议**：改用多轮对话收集，或在选项中加入"其他（请描述）"引导用户补充

---

### #3 多轮问答割裂用户体验
**阶段**：IDLE 引导
**定义行为**：一次性收集4项信息（需求描述、优先级、模式、执行引擎）
**实际行为**：工具限制导致需要多轮 AskUserQuestion 调用
**根因**：AskUserQuestion 每次只能问1个问题，且选项数量有限
**影响**：用户需要多次交互才能完成信息收集，体验割裂
**建议**：将4项信息合并为2轮（需求+优先级 / 模式+引擎），减少交互次数

---

### #4 quality-reviewer 错误修复路径
**阶段**：Phase 0 需求澄清
**定义行为**：quality-reviewer 发现 High 问题 → 重新调用 writer 修复
**实际行为**：H-1/H-2 是需求歧义（manifest_path 来源不明确），应退回 analyst 而非 writer
**根因**：axiom-draft 规则将所有 High 问题都路由到 writer，但 writer 只能修改文档格式，无法解决需求歧义
**影响**：错误的修复路径导致问题被掩盖而非真正解决
**建议**：区分问题类型——需求歧义退回 analyst，文档格式问题才调用 writer

---

### #5 axiom-draft 确认框时机错误
**阶段**：Phase 0 → Phase 1 过渡
**定义行为**：axiom-draft 应完成 Phase 0（需求澄清）+ Phase 1（架构设计）后再出现确认框
**实际行为**：Phase 0 完成后确认框就出现，选项直接跳到"进入 Phase 1.5"，跳过了 Phase 1 架构设计
**根因**：axiom-draft SKILL.md 的确认框选项写的是"进入 Phase 1.5"，暗示 Phase 1 已完成，但实际 Phase 1 尚未执行
**影响**：用户可能在架构设计前就进入专家评审，导致评审缺乏技术依据
**建议**：确认框应在 Phase 1 完成后出现，或将选项改为"继续 Phase 1 架构设计"

---

### #6 子代理分析错误（幻觉）
**阶段**：Phase 1 架构设计
**定义行为**：critic 子代理应基于真实文件内容进行分析
**实际行为**：critic 声称"manifest.md 无 checkbox 行"，实际第14-18行就是 checkbox 行
**根因**：子代理未实际读取文件，基于假设进行分析（幻觉）
**影响**：错误分析导致主 Claude 需要交叉验证，增加额外工作量；若主 Claude 不验证则会产生错误决策
**建议**：critic prompt 中强制要求"先读取相关文件，再进行分析"；主 Claude 对 Critical 问题必须交叉验证

---

### #7 评审规则冲突（Critical 问题 vs 评分阈值）
**阶段**：Phase 1.5 专家评审
**定义行为**：axiom-review 有两条退回规则：① critic 发现 Critical 问题 → 强制退回；② 综合评分 < 60 → 强制退回
**实际行为**：critic 评分 62（>60）但发现 Critical 问题，两条规则产生矛盾
**根因**：规则设计时未明确两条规则的优先级关系
**影响**：无法自动决策，需要人工判断；若按评分规则则 Critical 问题被忽略，若按 Critical 规则则评分规则形同虚设
**建议**：明确规则优先级：Critical 问题规则优先于评分阈值规则（即"有 Critical 问题必退回，无论评分多少"）

---

## 二、问题分类分析

### 按根因分类

| 类别 | 问题编号 | 数量 |
|------|---------|------|
| 工具约束（Claude Code API 限制） | #2、#3 | 2 |
| 规则设计缺陷（逻辑不完整） | #4、#5、#7 | 3 |
| 状态管理缺陷（写入幂等性） | #1 | 1 |
| 子代理质量（幻觉/未读文件） | #6 | 1 |

### 按严重程度分类

| 严重程度 | 问题编号 | 说明 |
|---------|---------|------|
| 高（阻断流程） | #1、#6、#7 | 需要人工干预才能继续 |
| 中（影响质量） | #4、#5 | 流程可继续但结果可能有误 |
| 低（体验问题） | #2、#3 | 功能正常但用户体验差 |

---

## 三、改进优先级建议

1. **P0 - 立即修复**：
   - #7 明确 Critical 规则优先于评分阈值（一行规则补充）
   - #5 修正 axiom-draft 确认框时机（调整选项文案）

2. **P1 - 近期修复**：
   - #4 区分 quality-reviewer 问题类型的路由逻辑
   - #6 在 critic prompt 中强制要求先读文件

3. **P2 - 长期优化**：
   - #1 active_context.md 写入幂等化
   - #2、#3 重新设计 IDLE 引导的信息收集方式

---

## 四、流程执行总结

| 阶段 | 状态 | 耗时（估算） | 备注 |
|------|------|------------|------|
| Phase 0 需求澄清 | 完成 | ~15分钟 | 发现不一致 #4 |
| Phase 1 架构设计 | 完成（含返工） | ~20分钟 | 发现不一致 #5、#6 |
| Phase 1.5 专家评审 | 完成（退回后修复） | ~25分钟 | 发现不一致 #7，6个子代理并行 |
| Phase 2 任务拆解 | 跳过（SMALL） | ~5分钟 | 工作量评估正确 |
| Phase 3 TDD 实现 | 完成 | ~10分钟 | 5/5 测试通过 |

**总计**：完整走完一个 SMALL 需求的 dev-flow 流程约需 75 分钟，其中约 30% 时间用于处理流程不一致问题。
