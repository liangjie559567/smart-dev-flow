# 需求分析修复：积分系统 - Quality Review 问题修复

**修复时间**：2026-02-21
**分析师**：Analyst
**触发**：quality-reviewer 发现 4 Critical + 4 High 问题

---

## Critical 问题修复

### C-001：US-004 过期提醒功能缺失验收条件

**决策**：过期提醒采用**被动查询模式**（用户查询余额时提示即将过期的积分），不做主动推送。

**新增验收标准**：

| # | 标准 | 验证方式 |
|---|------|--------|
| AC-EXPIRE-1 | 用户查询积分余额时，若存在 7 天内即将过期的积分批次，响应中包含 `expiring_soon` 字段，列出批次金额和过期时间 | 单元测试：构造含即将过期批次的数据，验证响应包含 expiring_soon 数组 |
| AC-EXPIRE-2 | `expiring_soon` 仅包含剩余有效期 <= 7 天且余额 > 0 的批次 | 单元测试：混合过期/未过期/已用完批次，验证过滤逻辑 |

**新增技术约束**：
- 过期提醒阈值固定为 7 天，不可配置（V1 简化）
- 不做主动推送（邮件/短信/WebSocket），排除出 V1 范围

---

### C-002：频率限制语义不明确

**决策**：
- "同一行为"定义为 `user_id + action_type` 的组合（如 `user_123 + daily_login`）
- 时间窗口采用**滑动窗口**，窗口大小由 `action_type` 的配置决定

**修改后的验收标准**：

| # | 标准 | 验证方式 |
|---|------|--------|
| AC-RATE-1 | 同一用户的同一 action_type 在配置的时间窗口内，积分发放次数不超过配置的上限。粒度：`user_id + action_type`，窗口：滑动窗口（从首次触发时刻起算） | 单元测试：同一用户同一行为连续触发 N+1 次，验证第 N+1 次被拒绝并返回 `RATE_LIMITED` 错误码 |
| AC-RATE-2 | 频率限制配置格式：`{ action_type: string, max_count: int, window_seconds: int }`，存储在积分规则表中 | 集成测试：配置 `daily_login` 为 `{max_count: 1, window_seconds: 86400}`，验证 24 小时内第二次登录不发放积分 |

**修改后的技术约束**：
- 频率限制键：`rate:{user_id}:{action_type}`，值为窗口内已触发次数
- 使用数据库计数（`COUNT WHERE created_at > NOW() - window_seconds`），不引入 Redis（V1 简化）
- 窗口精度：秒级

---

### C-003：兑换原子性边界未定义

**决策**：V1 仅支持**单库内兑换**（积分扣减 + 兑换记录写入在同一数据库事务中），不涉及外部系统调用。

**修改后的验收标准**：

| # | 标准 | 验证方式 |
|---|------|--------|
| AC-REDEEM-1 | 兑换操作在单个数据库事务中完成：扣减积分余额 + 写入兑换记录，任一步骤失败则整体回滚 | 单元测试：模拟扣减后写入失败，验证余额未变化 |
| AC-REDEEM-2 | 并发兑换同一用户积分时，通过行级锁（`SELECT ... FOR UPDATE`）防止超扣 | 并发测试：10 个并发请求兑换同一用户的全部积分，验证最终余额 >= 0 |

**修改后的技术约束**：
- 事务边界：单库事务（BEGIN/COMMIT/ROLLBACK），不使用分布式事务
- 外部系统对接（如发货、优惠券发放）排除出 V1 范围，兑换仅记录意图
- 并发控制：数据库行级锁（悲观锁），不使用乐观锁或分布式锁

---

### C-004：积分有效期起算点未定义

**决策**：有效期从**积分发放时间**起算，按自然天计算。

**修改后的验收标准**：

| # | 标准 | 验证方式 |
|---|------|--------|
| AC-EXPIRY-1 | 每笔积分的过期时间 = `issued_at + validity_days`，`validity_days` 由 action_type 配置决定，默认 365 天 | 单元测试：发放积分后验证 `expires_at = issued_at + 365 days` |
| AC-EXPIRY-2 | 过期积分不计入可用余额。余额查询条件：`expires_at > NOW() AND remaining > 0` | 单元测试：构造已过期批次，验证不计入余额 |

**修改后的技术约束**：
- 起算点：`issued_at`（积分入账时间戳，UTC）
- 计算方式：`expires_at = issued_at + interval '{validity_days} days'`
- 默认有效期：365 天，可按 action_type 配置覆盖
- 不支持自然年模式（如"每年12月31日统一过期"），排除出 V1

---

## High 问题修复

### H-001：积分发放"5秒内"是同步还是异步？

**决策**：**同步**。API 调用返回时积分已入账，"5秒内"是接口响应时间的 SLA 上限。

**修改后的验收标准**：

| # | 标准 | 验证方式 |
|---|------|--------|
| AC-ISSUE-1 | 积分发放为同步操作：API 返回 200 时积分已写入数据库，调用方无需轮询 | 集成测试：调用发放接口后立即查询余额，验证余额已增加 |
| AC-ISSUE-2 | 发放接口 P99 响应时间 <= 5 秒（含数据库写入） | 性能测试：100 次连续发放，验证 P99 <= 5s |

**修改后的技术约束**：
- 同步写入，无消息队列
- 超时阈值：5 秒（数据库写入超时则返回 500，由调用方重试）

---

### H-002：幂等键使用"请求ID"还是"行为ID"？幂等窗口时效？

**决策**：使用**调用方传入的请求ID**（`idempotency_key`），窗口 24 小时。

**修改后的验收标准**：

| # | 标准 | 验证方式 |
|---|------|--------|
| AC-IDEMP-1 | 发放接口要求调用方在请求头传入 `Idempotency-Key`（字符串，最长 64 字符），缺失则返回 400 | 单元测试：不传 key 返回 400，传入合法 key 返回 200 |
| AC-IDEMP-2 | 相同 `Idempotency-Key` 在 24 小时内重复调用，返回首次调用的结果（200 + 原始响应体），不重复发放积分 | 单元测试：同一 key 调用两次，验证积分只增加一次，第二次响应与第一次一致 |

**修改后的技术约束**：
- 幂等键：调用方生成，格式不限（建议 UUID），服务端存储于 `idempotency_keys` 表
- 幂等窗口：24 小时（`created_at + 24h` 后记录可被清理）
- 存储：数据库表（`idempotency_key VARCHAR(64) UNIQUE, response_body JSONB, created_at TIMESTAMP`）

---

### H-003：管理员配置排除UI但保留功能验收标准，测试路径不明

**决策**：管理员配置通过**数据库直接操作**（SQL/迁移脚本）完成，不提供 API 端点。

**修改后的验收标准**：

| # | 标准 | 验证方式 |
|---|------|--------|
| AC-ADMIN-1 | 积分规则（action_type、积分值、频率限制、有效期）通过数据库 seed 脚本配置，提供 `seeds/point_rules.sql` 示例文件 | 验证：执行 seed 脚本后查询规则表，确认数据正确写入 |

**修改后的技术约束**：
- 管理员 UI 和管理员 API 均排除出 V1
- 配置变更方式：直接修改数据库（SQL 脚本），运维人员操作
- 提供 seed 脚本作为配置模板

---

### H-005：过期调度频率？余额查询是实时计算还是依赖调度结果？

**决策**：**无调度任务**。余额查询为实时计算（查询时过滤过期批次），不依赖后台定时清理。

**修改后的验收标准**：

| # | 标准 | 验证方式 |
|---|------|--------|
| AC-BAL-1 | 余额查询为实时计算：`SUM(remaining) WHERE user_id = ? AND expires_at > NOW() AND remaining > 0`，不依赖任何后台调度 | 单元测试：插入含过期批次的数据，验证余额不含过期部分 |

**修改后的技术约束**：
- 无 cron/定时任务，过期积分通过查询条件自然排除
- 过期数据物理清理（可选）作为运维任务，不影响业务逻辑
- 查询性能保障：`point_batches` 表建立 `(user_id, expires_at)` 复合索引

---

## 排除范围调整

原排除范围新增以下条目：

| # | 排除项 | 理由 |
|---|--------|------|
| EX-NEW-1 | 主动过期提醒推送（邮件/短信/WebSocket） | C-001 决策：V1 仅做被动查询提醒 |
| EX-NEW-2 | 分布式事务 / 外部系统对接（发货、优惠券） | C-003 决策：V1 兑换仅记录意图，单库事务 |
| EX-NEW-3 | 自然年过期模式 | C-004 决策：V1 仅支持从发放时间起算 |
| EX-NEW-4 | 管理员 UI 和管理员 API | H-003 决策：V1 通过 SQL 脚本配置 |
| EX-NEW-5 | 过期积分定时清理调度 | H-005 决策：实时查询过滤，无需调度 |
| EX-NEW-6 | Redis 缓存层 | C-002/H-005 决策：V1 全部走数据库 |

---

## 决策摘要表

| 问题 | 决策 | 关键词 |
|------|------|--------|
| C-001 过期提醒 | 被动查询模式，余额接口附带 expiring_soon | 被动、7天阈值 |
| C-002 频率限制 | user_id + action_type 粒度，滑动窗口，DB 计数 | 滑动窗口、DB |
| C-003 兑换原子性 | 单库事务 + 行级锁，不涉及外部系统 | 单库、悲观锁 |
| C-004 有效期起算 | issued_at 起算，默认 365 天 | 发放时间 |
| H-001 发放同步性 | 同步写入，P99 <= 5s | 同步 |
| H-002 幂等键 | 调用方传入 Idempotency-Key，24h 窗口 | 请求ID、24h |
| H-003 管理员配置 | SQL seed 脚本，无 API | SQL 直接操作 |
| H-005 余额查询 | 实时计算，无调度任务 | 实时、无 cron |
