# éªŒè¯æŠ¥å‘Šï¼šAI API Relay å®ç°

**éªŒè¯æ—¶é—´**: 2026-02-21
**éªŒè¯èŒƒå›´**: 8ä¸ªæ ¸å¿ƒæ–‡ä»¶
**éªŒè¯æ–¹å¼**: é™æ€ä»£ç åˆ†æ

---

## éªŒæ”¶æ ‡å‡†æ ¸å¯¹è¡¨

### è´¦æˆ·ä¸è®¤è¯æ¨¡å—

#### âœ… GitHub OAuth é›†æˆï¼Œè‡ªåŠ¨åˆ›å»ºç”¨æˆ·è´¦æˆ·
- **æ–‡ä»¶**: `src/auth.ts` (L22-26)
- **è¯æ®**: NextAuth.js v5 é…ç½® GitHub providerï¼ŒDrizzleAdapter è‡ªåŠ¨åˆ›å»ºç”¨æˆ·
- **çŠ¶æ€**: é€šè¿‡

#### âœ… Google OAuth é›†æˆï¼Œè‡ªåŠ¨åˆ›å»ºç”¨æˆ·è´¦æˆ·
- **æ–‡ä»¶**: `src/auth.ts` (L27-30)
- **è¯æ®**: NextAuth.js v5 é…ç½® Google provider
- **çŠ¶æ€**: é€šè¿‡

#### âœ… é¦–æ¬¡ç™»å½•è‡ªåŠ¨ç”Ÿæˆ API Keyï¼ˆæ ¼å¼: sk- + 32ä½éšæœºå­—ç¬¦ï¼‰
- **æ–‡ä»¶**: `src/auth.ts` (L33-52)
- **è¯æ®**: signIn å›è°ƒä¸­æ£€æŸ¥ apiKeys è¡¨ï¼Œä¸å­˜åœ¨åˆ™ç”Ÿæˆ `sk-` + 32ä½åå…­è¿›åˆ¶å­—ç¬¦ä¸²
- **çŠ¶æ€**: é€šè¿‡

#### âš ï¸ API Key åŠé”€åç«‹å³å¤±æ•ˆï¼ˆç¼“å­˜å¤±æ•ˆæ—¶é—´ â‰¤ 5 ç§’ï¼‰
- **æ–‡ä»¶**: `src/app/api/v1/chat/completions/route.ts` (L6, L36)
- **è¯æ®**:
  - å†…å­˜ç¼“å­˜ KEY_CACHE æœ‰æ•ˆæœŸ 5 ç§’ (L36)
  - åŠé”€æ—¶è®¾ç½® Redis `revoked:` æ ‡è®° (src/app/api/keys/route.ts L87)
  - éªŒè¯æ—¶æ£€æŸ¥ revoked æ ‡è®° (L29-34)
- **é—®é¢˜**: åŠé”€æ ‡è®°æ£€æŸ¥åœ¨ resolveKey ä¸­ï¼Œä½†ç¼“å­˜å·²å‘½ä¸­æ—¶ä¸ä¼šé‡æ–°æ£€æŸ¥ revoked çŠ¶æ€
- **é£é™©**: 5ç§’å†…åŠé”€çš„ key ä»å¯ç»§ç»­ä½¿ç”¨
- **çŠ¶æ€**: éƒ¨åˆ†å®ç°ï¼ˆç¼“å­˜ç­–ç•¥æœ‰ç¼ºé™·ï¼‰

#### âœ… æ”¯æŒå¤šä¸ª API Key ç®¡ç†ï¼ˆåˆ›å»ºã€æŸ¥çœ‹ã€åŠé”€ï¼‰
- **æ–‡ä»¶**: `src/app/api/keys/route.ts`
- **è¯æ®**:
  - GET: åˆ—å‡ºç”¨æˆ·æ‰€æœ‰ API Keys (L19-36)
  - POST: åˆ›å»ºæ–° API Key (L39-63)
  - DELETE: åŠé”€ API Key (L66-94)
- **çŠ¶æ€**: é€šè¿‡

---

### API ä»£ç†æ¨¡å—

#### âœ… POST /v1/chat/completions ç«¯ç‚¹å®ç°
- **æ–‡ä»¶**: `src/app/api/v1/chat/completions/route.ts` (L47-160)
- **è¯æ®**: å®Œæ•´çš„ POST å¤„ç†å‡½æ•°
- **çŠ¶æ€**: é€šè¿‡

#### âœ… éªŒè¯ API Key æœ‰æ•ˆæ€§å’Œä½™é¢å……è¶³
- **æ–‡ä»¶**: `src/app/api/v1/chat/completions/route.ts` (L48-69)
- **è¯æ®**:
  - L48-51: éªŒè¯ Bearer token æ ¼å¼
  - L54-55: è°ƒç”¨ resolveKey éªŒè¯ API Key
  - L64-70: è°ƒç”¨ /api/internal/billing/deduct æ£€æŸ¥ä½™é¢
- **çŠ¶æ€**: é€šè¿‡

#### âœ… æ”¯æŒæµå¼å“åº”ï¼ˆSSE æ ¼å¼ï¼‰
- **æ–‡ä»¶**: `src/app/api/v1/chat/completions/route.ts` (L114-159)
- **è¯æ®**:
  - L58: æ£€æµ‹ stream å‚æ•°
  - L115-159: ä½¿ç”¨ TransformStream è½¬å‘æµå¼å“åº”
  - L154-158: è¿”å› SSE æ ¼å¼å“åº”å¤´
- **çŠ¶æ€**: é€šè¿‡

#### âœ… ä½™é¢ä¸è¶³è¿”å› HTTP 402
- **æ–‡ä»¶**: `src/app/api/v1/chat/completions/route.ts` (L69)
- **è¯æ®**: `if (deduct.status === 402) return err(402, "Insufficient balance")`
- **çŠ¶æ€**: é€šè¿‡

#### âœ… ä»£ç†è¯·æ±‚åˆ°ä¸Šæ¸¸ OpenAI API
- **æ–‡ä»¶**: `src/app/api/v1/chat/completions/route.ts` (L74-81)
- **è¯æ®**: è½¬å‘è¯·æ±‚åˆ° UPSTREAM (https://api.openai.com/v1/chat/completions)
- **çŠ¶æ€**: é€šè¿‡

#### âš ï¸ è®°å½•è°ƒç”¨æ—¥å¿—
- **æ–‡ä»¶**: `src/app/api/internal/usage/route.ts` (L11-30)
- **è¯æ®**: å†…éƒ¨æ¥å£ POST /api/internal/usage å†™å…¥ usageLogs è¡¨
- **é—®é¢˜**:
  - ä»£ç†è·¯ç”±ä¸­æœªè°ƒç”¨æ­¤æ¥å£è®°å½•æ—¥å¿—
  - ä»…åœ¨ settle æ—¶å¼‚æ­¥è°ƒç”¨ï¼Œä½†ä»£ç ä¸­æœªè§è°ƒç”¨
- **çŠ¶æ€**: æœªå®ç°ï¼ˆç¼ºå°‘æ—¥å¿—è®°å½•è°ƒç”¨ï¼‰

---

### è®¡è´¹ä¸å¥—é¤æ¨¡å—

#### âœ… å¥—é¤é¢åº¦ä¼˜å…ˆäºä½™é¢æ¶ˆè´¹
- **æ–‡ä»¶**: `src/app/api/internal/billing/route.ts` (L70-72)
- **è¯æ®**:
  ```
  const fromSub = Math.min(subCredits, estimated);
  const fromBalance = estimated - fromSub;
  ```
- **çŠ¶æ€**: é€šè¿‡

#### âœ… åŸå­æ€§æ‰£è´¹ï¼ˆMySQL äº‹åŠ¡ + SELECT FOR UPDATEï¼‰
- **æ–‡ä»¶**: `src/app/api/internal/billing/route.ts` (L41-97)
- **è¯æ®**:
  - L41-42: è®¾ç½®éš”ç¦»çº§åˆ« + å¼€å¯äº‹åŠ¡
  - L45-52: SELECT FOR UPDATE é”å®šä½™é¢è¡Œ
  - L97: æäº¤äº‹åŠ¡
- **çŠ¶æ€**: é€šè¿‡

#### âš ï¸ æ‰£è´¹å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
- **æ–‡ä»¶**: `src/app/api/internal/billing/route.ts` (L103-108)
- **è¯æ®**: try-catch-finally ä¸­ catch è°ƒç”¨ rollback
- **é—®é¢˜**:
  - settle å‡½æ•°ä¸­ `tx.amount_sub` å’Œ `tx.amount_balance` å­—æ®µä¸å­˜åœ¨ï¼ˆschema ä¸­æ— æ­¤å­—æ®µï¼‰
  - åº”ä¸º `estimated_cost` å’Œå®é™…æˆæœ¬å·®å€¼è®¡ç®—
- **çŠ¶æ€**: éƒ¨åˆ†å®ç°ï¼ˆsettle é€»è¾‘æœ‰ bugï¼‰

---

### ç”¨é‡ç»Ÿè®¡æ¨¡å—

#### âœ… è°ƒç”¨å†å²åˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
- **æ–‡ä»¶**: `src/app/api/usage/route.ts` (L55-66)
- **è¯æ®**: æ”¯æŒ page å’Œ pageSize å‚æ•°çš„åˆ†é¡µæŸ¥è¯¢
- **çŠ¶æ€**: é€šè¿‡

#### âœ… æ”¯æŒæŒ‰æ¨¡å‹ã€æ—¥æœŸèŒƒå›´ç­›é€‰
- **æ–‡ä»¶**: `src/app/api/usage/route.ts` (L11-24)
- **è¯æ®**: buildConditions æ”¯æŒ modelã€startDateã€endDateã€statusCode ç­›é€‰
- **çŠ¶æ€**: é€šè¿‡

#### âœ… æ”¯æŒå¯¼å‡º CSV æ ¼å¼
- **æ–‡ä»¶**: `src/app/api/usage/route.ts` (L35-52)
- **è¯æ®**: format=csv å‚æ•°è§¦å‘ CSV å¯¼å‡º
- **çŠ¶æ€**: é€šè¿‡

---

## å‘ç°çš„ç¼ºå£ä¸é—®é¢˜

### ğŸ”´ ä¸¥é‡é—®é¢˜

1. **settle å‡½æ•°å­—æ®µæ˜ å°„é”™è¯¯** (src/app/api/internal/billing/route.ts L140)
   - ä»£ç å¼•ç”¨ `tx.amount_sub` å’Œ `tx.amount_balance`
   - schema ä¸­å®é™…å­—æ®µä¸º `estimated_cost` å’Œ `actual_cost`
   - å¯¼è‡´ç»“ç®—é€»è¾‘å®Œå…¨å¤±æ•ˆ
   - **å½±å“**: æ— æ³•æ­£ç¡®è®¡ç®—é€€å·®é¢

2. **ç¼ºå°‘è°ƒç”¨æ—¥å¿—è®°å½•** (src/app/api/v1/chat/completions/route.ts)
   - ä»£ç†è·¯ç”±æœªè°ƒç”¨ POST /api/internal/usage è®°å½•æ—¥å¿—
   - ç”¨é‡ç»Ÿè®¡æ— æ³•è·å–å®æ—¶æ•°æ®
   - **å½±å“**: ç”¨é‡ç»Ÿè®¡åŠŸèƒ½ä¸å¯ç”¨

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

3. **API Key åŠé”€ç¼“å­˜ç«æ€æ¡ä»¶** (src/app/api/v1/chat/completions/route.ts L6-37)
   - å†…å­˜ç¼“å­˜å‘½ä¸­æ—¶ä¸æ£€æŸ¥ revoked çŠ¶æ€
   - åŠé”€å 5 ç§’å†…ä»å¯ä½¿ç”¨å·²ç¼“å­˜çš„ key
   - **å½±å“**: å®‰å…¨æ€§é™ä½

4. **settle å‡½æ•°å‚æ•°ä¸åŒ¹é…** (src/app/api/v1/chat/completions/route.ts L148)
   - è°ƒç”¨æ—¶ä¼ é€’ `inputTokens` å’Œ `outputTokens`
   - settle å‡½æ•°æœŸæœ› `actualInputTokens` å’Œ `actualOutputTokens`
   - **å½±å“**: ç»“ç®—è¯·æ±‚å‚æ•°é”™è¯¯

### ğŸŸ¢ è½»å¾®é—®é¢˜

5. **ç¼ºå°‘é”™è¯¯å¤„ç†** (src/app/api/keys/route.ts L12-15)
   - redisSet è°ƒç”¨æœª awaitï¼Œå¯èƒ½å¤±è´¥
   - æ— é”™è¯¯å¤„ç†æœºåˆ¶
   - **å½±å“**: Redis å†™å…¥å¤±è´¥æ—¶æ— æ„ŸçŸ¥

---

## ç»¼åˆè¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| éœ€æ±‚è¦†ç›–åº¦ | 70% | æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œä½†æœ‰2ä¸ªä¸¥é‡ç¼ºé™· |
| ä»£ç è´¨é‡ | 65% | æ¶æ„æ¸…æ™°ï¼Œä½†å­˜åœ¨å­—æ®µæ˜ å°„é”™è¯¯ |
| æµ‹è¯•è¦†ç›– | 0% | æ— æµ‹è¯•ä»£ç  |
| è§„èŒƒéµå¾ª | 80% | éµå¾ª Next.js å’Œ Drizzle çº¦å®š |
| **ç»¼åˆè¯„åˆ†** | **62/100** | **é€€å›ä¿®æ”¹** |

---

## å»ºè®®

### å¿…é¡»ä¿®å¤ï¼ˆé˜»å¡äº¤ä»˜ï¼‰
1. ä¿®æ­£ settle å‡½æ•°çš„å­—æ®µæ˜ å°„ï¼ˆL140-145ï¼‰
2. æ·»åŠ è°ƒç”¨æ—¥å¿—è®°å½•åˆ°ä»£ç†è·¯ç”±
3. ä¿®æ­£ settle å‡½æ•°çš„å‚æ•°åç§°

### åº”è¯¥ä¿®å¤ï¼ˆå½±å“åŠŸèƒ½ï¼‰
4. æ”¹è¿› API Key åŠé”€ç¼“å­˜ç­–ç•¥ï¼ˆæ¯æ¬¡éªŒè¯æ£€æŸ¥ revokedï¼‰
5. æ·»åŠ  Redis æ“ä½œçš„é”™è¯¯å¤„ç†

### å¯ä»¥ä¼˜åŒ–ï¼ˆéé˜»å¡ï¼‰
6. æ·»åŠ å•å…ƒæµ‹è¯•è¦†ç›–å…³é”®è·¯å¾„
7. æ·»åŠ è¯·æ±‚æ—¥å¿—å’Œç›‘æ§

---

## å†³ç­–

**ç»¼åˆè¯„åˆ† 62 åˆ† < 80 åˆ† â†’ å»ºè®®é€€å›ä¿®æ”¹**

éœ€è¦ä¿®å¤ä¸Šè¿° 3 ä¸ªå¿…é¡»é¡¹åé‡æ–°æäº¤éªŒè¯ã€‚
