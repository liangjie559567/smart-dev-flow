name: "Phase 1.5: 专家评审"
description: "通过5位专家视角并行评审并生成飞书汇报。"
prerequisites:
  - "docs/prd/${{ name }}-draft.md"
steps:
  - name: "解析执行器"
    type: "script"
    run: |
      WORKER_EXEC = read_router_worker_exec(".agent/rules/provider_router.rule")

  - name: "专家并行评审"
    type: "parallel"
    tasks:
      - run: "${WORKER_EXEC} --role .agent/prompts/roles/ux_director.md --input docs/prd/${{ name }}-draft.md"
      - run: "${WORKER_EXEC} --role .agent/prompts/roles/product_director.md --input docs/prd/${{ name }}-draft.md"
      - run: "${WORKER_EXEC} --role .agent/prompts/roles/domain_expert.md --input docs/prd/${{ name }}-draft.md"
      - run: "${WORKER_EXEC} --role .agent/prompts/roles/tech_lead.md --input docs/prd/${{ name }}-draft.md"
      - run: "${WORKER_EXEC} --role .agent/prompts/roles/critic.md --input docs/prd/${{ name }}-draft.md"
    wait_for_all: true

  - name: "汇总与同步"
    uses: "review-aggregator"
    with:
      inputs: ["docs/reviews/${{ name }}/review_*.md", "docs/prd/${{ name }}-draft.md"]
    actions:
      - "解决冲突 (Safety > Tech > Strategy)"
      - "生成 docs/prd/${{ name }}-rough.md"
      - "创建飞书文档"
    output: "${{ feishu_link }}"

  - name: "用户确认门禁"
    type: "gate"
    message: "专家评审已完成。飞书文档：${{ feishu_link }}。是否进入任务拆解？"
    options:
      - label: "是 (继续)"
        run: "workflow: decomposing"
      - label: "否 (停止)"
        run: "stop"
