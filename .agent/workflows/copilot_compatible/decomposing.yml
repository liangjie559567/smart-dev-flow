name: "Phase 2: 任务拆解"
description: "将 Rough PRD 转化为 Manifest 和子文档。"
prerequisites:
  - "docs/prd/${{ name }}-rough.md"
steps:
  - name: "解析执行器"
    type: "script"
    run: |
      WORKER_EXEC = read_router_worker_exec(".agent/rules/provider_router.rule")

  - name: "工期评估门禁"
    run: |
      if workload < 1 day:
        return "fast-track (skip decomposition)"
      else:
        continue

  - name: "架构设计 (Manifest)"
    uses: "system-architect"
    with:
      input: "docs/prd/${{ name }}-rough.md"
    output: "docs/tasks/${{ id }}/manifest.md"

  - name: "串行生成子文档"
    type: "loop"
    items: "${{ manifest.tasks }}"
    run: "${WORKER_EXEC} --role .agent/prompts/roles/sub_prd_writer.md --input docs/tasks/${{ id }}/manifest.md"
    context: ["docs/prd/${{ name }}-rough.md", "docs/tasks/${{ id }}/manifest.md", "docs/tasks/${{ id }}/sub_prds"]

  - name: "一致性审计 (PM Audit)"
    run: "PM Check (Alignment & Self-Consistency)"
    on_fail: "Auto-Fix Sub-PRD"

  - name: "用户确认门禁"
    type: "gate"
    message: "任务拆解已完成。是否开始开发？"
    options:
      - label: "是 (开发)"
        run: "workflow: implementing"
      - label: "否 (停止)"
        run: "stop"
