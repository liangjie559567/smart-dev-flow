#!/bin/sh
# ============================================================
# Axiom â€” Pre-commit Guard (T-301)
#
# åŠŸèƒ½: æ£€æŸ¥ active_context.md æ˜¯å¦åœ¨æœ¬æ¬¡æäº¤ä¸­è¢«æ›´æ–°
# è¡Œä¸º: è­¦å‘Šæ¨¡å¼ (warning-only)ï¼Œä¸é˜»æ–­ commit
# å®‰è£…: cp .agent/guards/pre-commit .git/hooks/pre-commit
#        chmod +x .git/hooks/pre-commit
# ============================================================

CONTEXT_FILE="active_context.md"
GUARD_NAME="Axiom Guard"

# â”€â”€ 1. æ£€æŸ¥ active_context.md æ˜¯å¦è¢« staged â”€â”€
if ! git diff --cached --name-only | grep -q "$CONTEXT_FILE"; then
    echo ""
    echo "âš ï¸  [$GUARD_NAME] $CONTEXT_FILE æœªåœ¨æœ¬æ¬¡æäº¤ä¸­æ›´æ–°ã€‚"
    echo "   å»ºè®®: è¯·ç¡®ä¿ä»»åŠ¡çŠ¶æ€å·²åŒæ­¥åˆ°è®°å¿†æ–‡ä»¶ã€‚"
    echo "   æç¤º: æ‰§è¡Œ /suspend å¯è‡ªåŠ¨ä¿å­˜ä¸Šä¸‹æ–‡ã€‚"
    echo ""
    # ä¸é˜»æ–­ (exit 0)ï¼Œä»…è­¦å‘Š
fi

# â”€â”€ 2. æ£€æŸ¥æ˜¯å¦æœ‰æœªè§£å†³çš„å†²çªæ ‡è®° â”€â”€
CONFLICT_FILES=$(git diff --cached --name-only | xargs grep -l "<<<<<<< " 2>/dev/null || true)
if [ -n "$CONFLICT_FILES" ]; then
    echo ""
    echo "âŒ [$GUARD_NAME] æ£€æµ‹åˆ°æœªè§£å†³çš„åˆå¹¶å†²çª:"
    echo "$CONFLICT_FILES"
    echo "   è¯·æ‰‹åŠ¨è§£å†³å†²çªåå†æäº¤ã€‚"
    echo ""
    exit 1  # å†²çªå¿…é¡»é˜»æ–­
fi

# â”€â”€ 3. CI Gate (Flutter analyze + test) â”€â”€
if [ -f "pubspec.yaml" ]; then
    if ! command -v flutter >/dev/null 2>&1; then
        echo ""
        echo "âŒ [$GUARD_NAME] æ£€æµ‹åˆ° Flutter é¡¹ç›®ï¼Œä½†æœªæ‰¾åˆ° flutter å‘½ä»¤ã€‚"
        echo "   è¯·å…ˆå®‰è£… Flutter å¹¶ç¡®ä¿ flutter analyze / flutter test å¯ç”¨ã€‚"
        echo ""
        exit 1
    fi

    echo "ğŸ” [$GUARD_NAME] è¿è¡Œ flutter analyze ..."
    if ! flutter analyze; then
        echo "âŒ [$GUARD_NAME] flutter analyze å¤±è´¥ï¼Œå·²é˜»æ–­æäº¤ã€‚"
        exit 1
    fi

    echo "ğŸ§ª [$GUARD_NAME] è¿è¡Œ flutter test ..."
    if ! flutter test; then
        echo "âŒ [$GUARD_NAME] flutter test å¤±è´¥ï¼Œå·²é˜»æ–­æäº¤ã€‚"
        exit 1
    fi
fi

# â”€â”€ 4. æ£€æŸ¥ .agent/ ç›®å½•ä¸­æ˜¯å¦æœ‰ TODO/FIXME æ ‡è®° â”€â”€
AGENT_TODOS=$(git diff --cached --name-only -- '.agent/' | xargs grep -n "TODO\|FIXME\|HACK\|XXX" 2>/dev/null || true)
if [ -n "$AGENT_TODOS" ]; then
    echo ""
    echo "ğŸ’¡ [$GUARD_NAME] .agent/ ä¸­å‘ç° TODO/FIXME æ ‡è®°:"
    echo "$AGENT_TODOS" | head -5
    echo "   (ä»…æé†’ï¼Œä¸é˜»æ–­)"
    echo ""
fi

exit 0
