#!/bin/sh
# ============================================================
# Axiom â€” Post-commit Guard (T-302)
#
# åŠŸèƒ½: æäº¤åè‡ªåŠ¨åˆ›å»º checkpoint tagï¼ˆå¦‚æœè·ä¸Šæ¬¡ > 30 åˆ†é’Ÿï¼‰
# è¡Œä¸º: é™é»˜æ¨¡å¼ï¼Œè‡ªåŠ¨åˆ›å»º tagï¼Œå¤±è´¥ä¸é˜»æ–­
# å®‰è£…: cp .agent/guards/post-commit .git/hooks/post-commit
#        chmod +x .git/hooks/post-commit
# ============================================================

GUARD_NAME="Axiom Guard"
CHECKPOINT_INTERVAL=1800  # 30 åˆ†é’Ÿ = 1800 ç§’

# â”€â”€ 1. è·å–ä¸Šä¸€ä¸ª checkpoint tag â”€â”€
LAST_CP=$(git tag -l "checkpoint-*" --sort=-creatordate 2>/dev/null | head -1)

CREATE_TAG=false

if [ -z "$LAST_CP" ]; then
    # æ²¡æœ‰ checkpointï¼Œåˆ›å»ºç¬¬ä¸€ä¸ª
    CREATE_TAG=true
else
    # è®¡ç®—è·ä¸Šæ¬¡ checkpoint çš„æ—¶é—´å·®
    LAST_CP_TIME=$(git log -1 --format=%ct "$LAST_CP" 2>/dev/null || echo 0)
    CURRENT_TIME=$(date +%s)
    DIFF=$(( CURRENT_TIME - LAST_CP_TIME ))

    if [ "$DIFF" -gt "$CHECKPOINT_INTERVAL" ]; then
        CREATE_TAG=true
    fi
fi

# â”€â”€ 2. åˆ›å»º checkpoint tag â”€â”€
if [ "$CREATE_TAG" = true ]; then
    TAG_NAME="checkpoint-$(date +%Y%m%d-%H%M%S)"
    if git tag "$TAG_NAME" 2>/dev/null; then
        echo "âœ… [$GUARD_NAME] æ£€æŸ¥ç‚¹å·²åˆ›å»º: $TAG_NAME"
    else
        echo "âš ï¸  [$GUARD_NAME] æ£€æŸ¥ç‚¹åˆ›å»ºå¤±è´¥ (éé˜»æ–­)"
    fi
fi

# â”€â”€ 3. ç»Ÿè®¡æœ¬æ¬¡æäº¤çš„å˜æ›´ â”€â”€
CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | wc -l | tr -d ' ')
AGENT_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null | grep "^\.agent/" | wc -l | tr -d ' ')

if [ "$AGENT_FILES" -gt 0 ]; then
    echo "ğŸ“Š [$GUARD_NAME] æœ¬æ¬¡æäº¤: ${CHANGED_FILES} æ–‡ä»¶ (å…¶ä¸­ ${AGENT_FILES} ä¸ª Agent æ–‡ä»¶)"
fi

exit 0
